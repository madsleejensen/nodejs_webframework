var path = require("path");
var url = require("url");
var fileSystem = require("fs");
var mime = require("mime");

module.exports = function(application, request, response, callback) {
	if (path.extname(request.url) == '') {
		callback(null, false); // no extension name in the request meaning client is not requesting a static file.
		return;
	}
	
	var parts = url.parse(request.url);
	var filepath = path.join(application.getConfig('system.localPath'), 'public', path.normalize(parts.pathname));

	fileSystem.stat(filepath, function(error, stat) {
		if (error || !stat.isFile()) {
			callback(null, false); 
		}
		else {
			var readStream = fileSystem.createReadStream(filepath, {
				flags: 'r',
			});
			
			var contentType = mime.lookup(filepath, "text/plain");
			response.writeHead(200, {'Content-Type': contentType });
			
			readStream.pipe(response);
			callback(null, true);
		}
	});	
};