var path = require("path");
var fileSystem = require("fs");
var Step = require("step");

module.exports = function(application) {
	var instance = {};
	
	/**
	 * Enter a dispatch loop will continue to handle requests till request.isDispatched() is marked `true`.
	 * @param {contentcube/request} request
	 * @param {contentcube/response} response
	 * @param {Function} callback 
	 */
	instance.dispatch = function(request, response, callback) {
		
		(function loop(callback) {
			Step(
				function initializeController() {
					loadController(request.controllerName, this);
				},
				function runActionOnController(error, controller) {
					if (error) throw error;
					request.setDispatched(true);
					controller.handle(request.actionName, this);
				},
				function onActionHandled(error) {	
					if (error) {
						if (error.family == 'contentcube' && request.controllerName != 'error') { // prevent it from going into a infinite loop.
							request.controllerName = "error";
							request.actionName = "error";
							request.setParams([error]);

							return loop(callback);
						}

						return callback(error);
					}

					if (!request.isDispatched()) {
						loop(callback);
					}
					else {
						callback();
					}
				}
			);
		})(callback);
		
		/**
		 * finds an instantiates a controller by name.
		 * @param {String} controllerName
	     * @param {Function} callback
		 */
		function loadController(controllerName, callback) {
			var filepath = path.join(application.getConfig('system.localPath'), path.normalize('/application/controllers/' + controllerName + '.js'));
			
			path.exists(filepath, function(exists) {
				if (exists) {
					var controllerCreator = require(filepath);
					var controller = controllerCreator(application, request, response);
					callback(null, controller);
				}
				else {
					var error = new Error("Cannot find controller file for " + controllerName + " looked in " + filepath);
						error.type = "ERROR_NO_CONTROLLER_FOUND";
						error.family = 'contentcube';
						error.code = 404;

					callback(error);
				}
			});	
		}
	};
	
	return instance;
};